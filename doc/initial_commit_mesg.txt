Initial commit for ccsailportal.

The app as it exists now was generated by a shell script and can 
serve as a base for a range of rails apps.

The shell script is copied below. This is a list of what
it installs and generates:

Rails 2.1 is frozen into vendor/rails.

Mysql is selected as the database and the configuration
file: database.yml is setup to access mysql from either 
MRI or JRuby.

The script will add a password into environment sections
in database.yml. Set the password variable with your 
own password.
 
Installed plugins include:

rspec:                  git://github.com/dchelimsky/rspec.git
rspec_rails:            git://github.com/dchelimsky/rspec-rails.git
webrat:                 http://svn.eastmedia.net/public/plugins/webrat
acts_as_state_machine:  http://elitists.textdriven.com/svn/plugins/acts_as_state_machine/trunk/
restful-authentication  git://github.com/stepheneb/restful-authentication.git

The restful-authentication plugin is my fork of the main branch. There 
are some bugs fixed in the generator. 
  
The generator is run for restful-authentication and this generates
an authentication system as well as rspec specs and story tests. 

Functionalities of the authentication system include: 'remember me',
email account activation, and the ability to suspend users.

The file public/index.html is deleted.

Sample versions of config/database.yml and config/environment.yml
are created and the svn repository is told to ignore the 
following file patterns:

  config/database.yml
  config/environment.yml
  config/initializers/site_keys.rb
  tmp/*
  log/*

Results of running the 265 spec tests installed by restful-authentication::

$ rake spec
Finished in 3.030516 seconds

265 examples, 0 failures

There are 20 stories included with the restful-authentication plugin.
Right now they all fail but they are easy to fix.

$ ruby stories/rest_auth_stories.rb
...
20 scenarios: 0 succeeded, 20 failed, 0 pending

Running the 
== The generation script for ccsail portal:

rm -rf ccsailportal/ # useful if running this script more than once to recreate the same app
svn co https://svn.concord.org/svn/ccsailportal/trunk ccsailportal
rails ccsailportal --database=mysql 
cd ccsailportal/

rm public/index.html

# setup the database config to work with either MRI or JRuby
ruby -e 'File.open("config/database.yml", "r+") {|f| content = f.read; content.gsub!("adapter: mysql", "adapter: <% if RUBY_PLATFORM =~ /java/ %>jdbcmysql<% else %>mysql<% end %>"); f.pos=0; f.write content }'

rake rails:freeze:gems
svn add README Rakefile app config db doc lib public script test vendor 

# add the directories log and tmp but not any files in these directories and tell 
# svn to ignore any files that end up there.
svn add --non-recursive log tmp 
svn propset svn:ignore '*' log tmp 

# Only check into svn a sample copy of the database config.
# The real database.yml will have a password in it that shouldn't be checked in. 
svn mv config/database.yml config/database.sample.yml
svn propset svn:ignore 'database.yml' config
cp config/database.sample.yml config/database.yml

# insert password for mysql into database.yml
ruby -e 'password = "starfish"; File.open("config/database.yml", "r+") {|f| content = f.read; content.gsub!(/password:.*$/, "password: #{password}"); f.pos=0; f.write content }'

rake db:create:all
rake db:migrate:reset # useful if running this script more than once to recreate the same app

script/plugin install git://github.com/dchelimsky/rspec.git

script/plugin install git://github.com/dchelimsky/rspec-rails.git
# replace '-' in plugin name with '_'
mv vendor/plugins/rspec-rails vendor/plugins/rspec_rails

script/generate rspec

# script/plugin install git://github.com/brynary/webrat.git
# git not working for webrat
script/plugin install http://svn.eastmedia.net/public/plugins/webrat

# install my fork of the restful authentication plugin
script/plugin install git://github.com/stepheneb/restful-authentication.git
# script/plugin install git://github.com/technoweenie/restful-authentication.git
# replace '-' in plugin name with '_'
mv vendor/plugins/restful-authentication vendor/plugins/restful_authentication

script/plugin install http://elitists.textdriven.com/svn/plugins/acts_as_state_machine/trunk/

# use restful-authentication's generator to create a user model along with 
# migrations, controllers for users and sessions, simple views, and rspec tests
script/generate authenticated user session --include-activation --stateful --rspec
svn propset svn:ignore 'site_keys.rb' config/initializers

svn add db stories spec app script lib vendor --force --quiet

# make code changes partially described in vendor/plugins/restful-authentication/README

# add: config.active_record.observers = :users_observer to config/environment.rb
ruby -e 'File.open("config/environment.rb", "r+") {|f| content = f.read; content.gsub!(/^end$/, "  config.active_record.observers = :user_observer\nend\n"); f.pos=0; f.write content }'

# add: 'include AuthenticatedSystem' and 'before_filter :login_from_cookie' to application_controller.rb
ruby -e 'File.open("app/controllers/application.rb", "r+") {|f| content = f.read; content.gsub!(/ApplicationController < ActionController::Base$/, "  ApplicationController < ActionController::Base\n  include AuthenticatedSystem\n  before_filter :login_from_cookie\n"); f.pos=0; f.write content }'

svn mv config/environment.rb config/environment.sample.rb
svn propset svn:ignore 'environment.rb' config
cp config/environment.sample.rb config/environment.rb

# delete the secret session key from environment.sample.rb so it isn't checked in
ruby -e "File.open('config/environment.sample.rb', 'r+') {|f| content = f.read; secret = content[/:secret\s*=>\s*'(.*)'/, 1]; f.pos=0; f.write content.gsub(secret, '****') }"

rake db:migrate

# for some reason this needed to be done again:
svn propset svn:ignore 'database.yml' config
svn propset svn:ignore 'environment.rb' config
